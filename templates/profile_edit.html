<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar perfil - Rede Social Sara Nossa Terra</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <header class="topbar">
        <div>
            <strong>{{ user['nome'] }}</strong>
            <small>{{ user['igreja'] }} ‚Ä¢ {{ user['cidade'] }}/{{ user['pais'] }} ‚Ä¢ {{ user['role']|upper }}</small>
        </div>
    </header>

    <main class="container register-single">
        <section class="card">
            <h1>Editar perfil</h1>
            <p class="subtitle">Atualize seus dados pessoais e foto</p>
            {% if flash %}
                <div class="alert">{{ flash }}</div>
            {% endif %}

            <form method="post" action="/profile" enctype="multipart/form-data" class="form">
                <label>Nome</label>
                <input type="text" name="nome" value="{{ user['nome'] }}" required>

                <label>Igreja</label>
                <input type="text" name="igreja" value="{{ user['igreja'] }}" required>

                <label>Cidade</label>
                <input type="text" name="cidade" value="{{ user['cidade'] }}" required>

                <label>Pa√≠s</label>
                <input type="text" name="pais" value="{{ user['pais'] }}" required>

                <label>Telefone (com DDD e pa√≠s)</label>
                <input type="text" name="telefone" class="phone-mask" inputmode="numeric" value="{{ user['telefone'] }}" placeholder="+55 (11) 99999-9999" maxlength="20">

                <label>Faixa et√°ria</label>
                <select name="faixa_etaria" required>
                    <option value="Jovem" {% if user['faixa_etaria'] == 'Jovem' %}selected{% endif %}>Jovem</option>
                    <option value="Adulto" {% if user['faixa_etaria'] == 'Adulto' %}selected{% endif %}>Adulto</option>
                </select>

                <label>Nova senha (opcional)</label>
                <div class="password-field">
                    <input id="nova_senha" type="password" name="nova_senha" minlength="8" placeholder="M√≠nimo 8 caracteres">
                    <button type="button" class="toggle-password" data-target="nova_senha">üëÅÔ∏è</button>
                </div>

                <label>Nova foto (opcional)</label>
                <input type="file" name="foto" accept=".jpg,.jpeg,.png,.webp">

                <div class="form-actions">
                    <button type="submit">Salvar</button>
                    <a href="/feed" class="btn-cancel">Cancelar</a>
                </div>
            </form>

            <div class="section-label">Excluir perfil</div>
            <form method="post" action="/profile/delete" class="form" onsubmit="return confirm('Deseja excluir seu perfil? Esta a√ß√£o √© irrevers√≠vel.');">
                {% if user['role'] == 'admin' %}
                    <label>Como admin, selecione outro usu√°rio para assumir admin</label>
                    <select name="replacement_admin_id" required>
                        <option value="">Selecione um usu√°rio</option>
                        {% for candidate in admin_candidates %}
                            <option value="{{ candidate['id'] }}">{{ candidate['nome'] }} ({{ candidate['email'] }})</option>
                        {% endfor %}
                    </select>
                {% endif %}
                <label>Digite EXCLUIR para confirmar</label>
                <input type="text" name="confirm_delete_text" placeholder="EXCLUIR" required>
                <button type="submit" class="btn-danger">Excluir meu perfil</button>
            </form>
        </section>
    </main>
</body>
<script>
    function formatPhone(value) {
        const digits = (value || '').replace(/\D/g, '').slice(0, 15);
        if (!digits) return '';
        if (digits.startsWith('55')) {
            const ddd = digits.slice(2, 4);
            const part1 = digits.slice(4, 9);
            const part2 = digits.slice(9, 13);
            let result = '+55';
            if (ddd) result += ` (${ddd}`;
            if (ddd.length === 2) result += ')';
            if (part1) result += ` ${part1}`;
            if (part2) result += `-${part2}`;
            return result;
        }
        return `+${digits}`;
    }

    document.querySelectorAll('.phone-mask').forEach((input) => {
        input.addEventListener('input', (event) => {
            event.target.value = formatPhone(event.target.value);
        });
        input.value = formatPhone(input.value);
    });

    document.querySelectorAll('.toggle-password').forEach((button) => {
        button.addEventListener('click', () => {
            const input = document.getElementById(button.dataset.target);
            if (!input) return;
            input.type = input.type === 'password' ? 'text' : 'password';
        });
    });
</script>
</html>